import React, { Suspense, lazy } from 'react'
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom'
import { Toaster } from 'react-hot-toast'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { ReactQueryDevtools } from '@tanstack/react-query-devtools'
import { AuthProvider } from './contexts/AuthContext'
import { ThemeProvider } from './contexts/ThemeContext'
import { WebSocketProvider } from './contexts/WebSocketContext'
import { CompanyProvider } from './contexts/CompanyContext'
import { NotificationProvider } from './contexts/NotificationContext'
import PrivateRoute from './components/Common/PrivateRoute'
import Layout from './components/Layout/Layout'
import LoadingSpinner from './components/Common/LoadingSpinner'
import ErrorBoundary from './components/Common/ErrorBoundary'

// Lazy load pages for better performance
const Login = lazy(() => import('./pages/Auth/Login'))
const Register = lazy(() => import('./pages/Auth/Register'))
const ForgotPassword = lazy(() => import('./pages/Auth/ForgotPassword'))
const ResetPassword = lazy(() => import('./pages/Auth/ResetPassword'))
const VerifyEmail = lazy(() => import('./pages/Auth/VerifyEmail'))

const Dashboard = lazy(() => import('./pages/Dashboard/Dashboard'))
const Transactions = lazy(() => import('./pages/Transactions/Transactions'))
const TransactionDetail = lazy(() => import('./pages/Transactions/TransactionDetail'))
const Upload = lazy(() => import('./pages/Documents/Upload'))
const Documents = lazy(() => import('./pages/Documents/Documents'))
const Reconciliation = lazy(() => import('./pages/Reconciliation/Reconciliation'))
const Reports = lazy(() => import('./pages/Reports/Reports'))
const ReportBuilder = lazy(() => import('./pages/Reports/ReportBuilder'))
const TaxCenter = lazy(() => import('./pages/Tax/TaxCenter'))
const TaxForms = lazy(() => import('./pages/Tax/TaxForms'))
const Analytics = lazy(() => import('./pages/Analytics/Analytics'))
const Insights = lazy(() => import('./pages/AI/Insights'))
const Settings = lazy(() => import('./pages/Settings/Settings'))
const Profile = lazy(() => import('./pages/Settings/Profile'))
const Billing = lazy(() => import('./pages/Settings/Billing'))
const Integrations = lazy(() => import('./pages/Settings/Integrations'))
const Team = lazy(() => import('./pages/Settings/Team'))
const CompanySettings = lazy(() => import('./pages/Settings/CompanySettings'))

// Create Query Client
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 minutes
      cacheTime: 10 * 60 * 1000, // 10 minutes
      retry: 2,
      refetchOnWindowFocus: false,
    },
  },
})

function App() {
  return (
    <ErrorBoundary>
      <QueryClientProvider client={queryClient}>
        <ThemeProvider>
          <AuthProvider>
            <WebSocketProvider>
              <CompanyProvider>
                <NotificationProvider>
                  <Router>
                    <div className="App min-h-screen bg-gray-50">
                      <Toaster 
                        position="top-right"
                        toastOptions={{
                          duration: 4000,
                          style: {
                            background: '#363636',
                            color: '#fff',
                          },
                          success: {
                            duration: 3000,
                            iconTheme: {
                              primary: '#10B981',
                              secondary: '#fff',
                            },
                          },
                          error: {
                            duration: 5000,
                            iconTheme: {
                              primary: '#EF4444',
                              secondary: '#fff',
                            },
                          },
                        }}
                      />
                      
                      <Suspense fallback={<LoadingSpinner fullScreen />}>
                        <Routes>
                          {/* Auth Routes */}
                          <Route path="/login" element={<Login />} />
                          <Route path="/register" element={<Register />} />
                          <Route path="/forgot-password" element={<ForgotPassword />} />
                          <Route path="/reset-password" element={<ResetPassword />} />
                          <Route path="/verify-email" element={<VerifyEmail />} />
                          
                          {/* Protected Routes */}
                          <Route path="/" element={
                            <PrivateRoute>
                              <Layout />
                            </PrivateRoute>
                          }>
                            <Route index element={<Navigate to="/dashboard" replace />} />
                            <Route path="dashboard" element={<Dashboard />} />
                            
                            {/* Transactions */}
                            <Route path="transactions">
                              <Route index element={<Transactions />} />
                              <Route path=":id" element={<TransactionDetail />} />
                              <Route path="new" element={<TransactionDetail />} />
                            </Route>
                            
                            {/* Documents */}
                            <Route path="upload" element={<Upload />} />
                            <Route path="documents" element={<Documents />} />
                            
                            {/* Reconciliation */}
                            <Route path="reconciliation" element={<Reconciliation />} />
                            
                            {/* Reports */}
                            <Route path="reports">
                              <Route index element={<Reports />} />
                              <Route path="builder" element={<ReportBuilder />} />
                            </Route>
                            
                            {/* Tax */}
                            <Route path="tax">
                              <Route index element={<TaxCenter />} />
                              <Route path="forms" element={<TaxForms />} />
                            </Route>
                            
                            {/* Analytics */}
                            <Route path="analytics" element={<Analytics />} />
                            
                            {/* AI Insights */}
                            <Route path="insights" element={<Insights />} />
                            
                            {/* Settings */}
                            <Route path="settings">
                              <Route index element={<Navigate to="profile" replace />} />
                              <Route path="profile" element={<Profile />} />
                              <Route path="company" element={<CompanySettings />} />
                              <Route path="team" element={<Team />} />
                              <Route path="billing" element={<Billing />} />
                              <Route path="integrations" element={<Integrations />} />
                              <Route path="notifications" element={<Settings />} />
                              <Route path="security" element={<Settings />} />
                              <Route path="preferences" element={<Settings />} />
                            </Route>
                          </Route>
                          
                          {/* 404 */}
                          <Route path="*" element={<Navigate to="/dashboard" replace />} />
                        </Routes>
                      </Suspense>
                    </div>
                  </Router>
                </NotificationProvider>
              </CompanyProvider>
            </WebSocketProvider>
          </AuthProvider>
        </ThemeProvider>
        
        {process.env.NODE_ENV === 'development' && <ReactQueryDevtools />}
      </QueryClientProvider>
    </ErrorBoundary>
  )
}

export default App
